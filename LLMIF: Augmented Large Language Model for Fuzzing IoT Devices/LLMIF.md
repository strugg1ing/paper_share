#### S&P 2024 　　　　　　　　港理工＆南邮
---  
## <center>LLMIF: Augmented Large Language Model for Fuzzing IoT Devices
## Abstract
<p style="text-align: justify;">尽管模糊测试在验证网络协议实现的正确性方面非常有效，但现有的物联网协议模糊测试方法仍面临多个限制，包括消息格式混淆、消息依赖关系未解决以及测试用例缺乏评估等问题。这些限制显著削弱了物联网模糊测试工具在漏洞识别方面的能力。在本工作中，我们展示了协议规范包含丰富的协议消息描述，这些描述可用于克服上述限制并指导物联网协议的模糊测试。为实现规范分析的自动化，我们将大语言模型与规范内容相结合，并驱动其执行两个任务（即协议信息提取和设备响应推理）。我们进一步设计并实现了一种模糊测试算法 LLMIF，将大语言模型整合到物联网模糊测试中。最后，我们选择 Zigbee 作为目标协议并进行了全面评估。评估结果显示，LLMIF 成功解决了上述限制。与现有的 Zigbee 模糊测试工具相比，它的协议消息覆盖率和代码覆盖率分别提升了 55.2% 和 53.9%。除了覆盖率的提升外，LLMIF 还在真实的 Zigbee 设备上发现了 11 个漏洞，其中包括 8 个此前未知的漏洞，其中 7 个漏洞未被现有的 Zigbee 模糊测试工具检测到。
</p>

## 1. Introduction
<p style="text-align: justify;">
　　确保物联网协议实现的正确性至关重要，因为这些协议保证了物联网设备的预期功能。在关键基础设施（如医疗、交通和能源）中，物联网设备的故障或崩溃可能会导致灾难性后果【1】。协议实现中的一个错误可能引发一连串难以诊断和纠正的故障【2】。尤其是网络协议模糊测试技术被广泛用于识别协议实现中的漏洞【3】【4】【5】【6】【7】。该技术通过生成定制的消息并将其传输至目标设备，以尝试触发意外行为。由于生成的消息符合协议格式要求，网络协议模糊测试相比于二进制模糊测试更具灵活性【8】【9】。它能够轻松地针对不同的协议实现，而无需考虑源代码的可用性和目标设备的硬件配置。</p>
<p style="text-align: justify;">
　　网络协议模糊测试涵盖了多个不同阶段，即模糊测试种子生成、种子变异、测试用例评估和用例扩充。不幸的是，现有的物联网模糊测试工具在设计范围和有效性上存在某些限制，限制了其设计范围和有效性。(L.1) 消息格式混淆。物联网消息通常具有复杂结构，包括精心设计的报头和负载。在缺乏关于这些消息格式的知识情况下，会出现两个主要问题。首先，模糊测试工具的种子生成仅限于相对较少的消息类型。其次，变异过程可能无效，因为它们通常会生成格式错误的测试用例，或忽视对关键位/字节的变异，而这可能暴露漏洞。(L.2) 消息依赖关系未解决。物联网协议展示了一个庞大的设备状态空间，只有通过精心安排的消息序列才能有效导航。如果不解决这些消息依赖关系，丰富测试用例并创建复杂的消息序列将成为一项艰巨的任务。(L.3) 缺乏测试用例评估。基于执行反馈（例如代码覆盖率）对测试用例进行评估是保留进一步检查的有趣用例的标准方法【11】。如果没有适当的评估策略，模糊测试工具将持续生成低质量的测试用例，从而导致模糊测试效果不佳。</p>
<p style="text-align: justify;">
　　遗憾的是，克服上述障碍来模糊测试物联网设备并非易事。(1) 先前的研究【12】使用机器学习技术从纯文本网络跟踪中推断消息格式。然而，物联网协议中使用的灵活且供应商特定的身份验证方案（例如定制的 Zigbee 链接密钥【13】）使得收集纯文本跟踪数据成为一项挑战。(2) 由于消息格式和设备属性的多样性，物联网协议通常缺乏协议状态机的正式定义。这种缺乏定义使得构建消息依赖关系变得复杂。此外，依赖于网络跟踪分析的现有方法【6】【7】在面对定制的身份验证方案时难以奏效。(3) 由于对保护知识产权和避免暴露漏洞的需求，物联网供应商通常不愿共享设备固件的源代码甚至二进制文件。这种不愿共享阻碍了模糊测试工具收集有价值的反馈信息，如代码覆盖率。</p>
<p style="text-align: justify;">
　　为了克服这些限制，我们提出了一个关键的观察：协议规范提供了丰富的消息描述，可以用于指导模糊测试过程。首先，鉴于这些描述包括了消息报头和负载格式的介绍性细节，可以提取这些信息以增强消息覆盖率并构建有效的变异操作符。其次，这些描述往往通过设备属性的相互作用微妙地描绘出消息依赖关系。例如，Zigbee 的 Identify 消息的描述为“这将启动设备的识别过程”，而 AddGroupIfIdentifying 消息的描述为“该消息允许设备在识别自身的条件下添加一个组”，暗示了这两个消息在设备的识别状态下存在关联。最后，这些描述概述了消息处理和响应生成的工作流程，可用于评估测试用例。给定一个传输的测试用例及随后的响应，可以利用这些描述来判断消息执行是否符合规范，导致合法的设备状态转换，或者是否违反规范，导致未定义的设备状态转换。触发设备状态转换的测试用例将被保留，作为后续模糊测试轮次中的新种子。</p>
<p style="text-align: justify;">
　　利用规范来指导物联网模糊测试需要具备文本总结和推理能力。尽管这些任务对人类而言相对简单，但却费时费力且易出错。例如，总结 Zigbee 的 1,213 页文档中指定的 140 多种消息类型格式可能会耗费数天的人力。受大语言模型（LLM）在各种自然语言处理任务中取得的最新进展的启发，我们提出将规范内容扩充至 LLM，并引导其回答协议相关问题。生成的回答随后用于支持模糊测试的各个阶段。我们选择 Zigbee【14】作为我们的目标物联网协议，因为该协议已在全球近 3 亿个节点中实现。具体而言，我们首先应用 LLM 扩充方法，将规范内容注入 LLM。随后，扩充后的 LLM 被分配两个任务：协议信息提取和设备响应推理。对于协议信息提取任务，LLM 被要求从规范中提取有用的协议信息，例如消息格式、重要字段值、报头结构和消息依赖关系。此方法解决了限制 L.1 和 L.2。对于设备响应推理任务，给定生成的测试用例及设备响应，LLM 利用消息描述判断该测试用例是否促成设备状态转换。结果随后用于评估测试用例，从而解决限制 L.3。</p>
<p style="text-align: justify;">
　　最后，我们提出了一种模糊测试算法 LLMIF，将 LLM 集成到 Zigbee 模糊测试中。在每轮模糊测试中，LLMIF 首先利用 LLM 提取的信息（消息负载格式、重要字段值和报头结构）生成种子并执行变异。然后，它将生成的测试用例传输到目标设备，监控设备崩溃并等待设备响应。在收集到的响应中，LLMIF 进一步指示扩充后的 LLM 评估测试用例的质量。对于那些促进设备状态转换的用例，LLMIF 会根据提取的消息依赖关系丰富它们，以构建新的种子，并优先在后续的模糊测试轮次中使用这些种子。
</p>
<p style="text-align: justify;">
　　
我们的评估结果展示了 LLMIF 在代码覆盖率和漏洞识别方面的有效性。与基线相比，LLMIF 将消息覆盖率提高了 55.2%，代码覆盖率提高53.9%。此外，LLMIF 在发现 Zigbee 协议实现中的关键漏洞方面表现出色。我们测试了 11 个实际 Zigbee 设备，并成功识别出 8 个零日漏洞，其中 7 个被现有模糊测试工具忽略。总之，我们的工作做出以下贡献：

* 我们利用扩展的大语言模型（LLM）来分析协议规范，克服了物联网模糊测试的限制，即未知的消息格式、未解决的消息依赖关系和缺乏测试用例评估。
* 我们将扩展的 LLM 集成到 Zigbee 模糊测试中，并提出了模糊测试算法 LLMIF。该算法利用 LLM 的结果来增强模糊测试的各个阶段，包括种子生成、变异、测试用例评估和测试用例扩展。我们还实现了一个用于实际 Zigbee 设备模糊测试的原型【15】。
* 我们进行了实验，展示了 LLMIF 的有效性。与基线相比，LLMIF 更有效地提高了消息类型和协议实现代码的覆盖率。除了覆盖率的提升外，LLMIF 还在现成的 Zigbee 设备中发现了 11 个漏洞，其中包括 8 个零日漏洞，大部分被现有模糊测试工具忽略。

</p>

## 2. Backgrond
<p style="text-align: justify;">
　　在本节中，我们首先介绍 Zigbee 中的主要概念，然后提供一些大型语言模型的背景知识。
</p>

##### Zigbee Protocol

<p style="text-align: justify;">
　　Zigbee 是一种通信协议，旨在为物联网设备提供低功耗、低成本的无线网状网络，并规范了一系列设备功能，例如照明和锁定。为了在 Zigbee 生态系统中提供无缝的通信，Zigbee 联盟在协议规范中提供了“集群”这一概念【16】，它定义了一组设备可以遵循的通用消息格式和数据结构。例如，Zigbee 规定了一个“组”集群（集群ID 0x0004），允许设备被分配到一个或多个组，并支持对多个设备的同时控制。该集群定义了几个设备属性，例如组表，设备应该支持这些属性以指定当前的分组状态。此外，该集群定义了六种具有固定负载格式的消息类型用于通信。例如，表 1 显示了“如果正在识别则添加组”消息（命令 ID 0x05）的格式，如果设备当前处于识别状态，则可以添加消息负载中指定的组